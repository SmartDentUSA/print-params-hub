<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>API Data Export - Sistema B | Teste de Dados</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --text: #1e293b;
      --text-muted: #64748b;
      --border: #e2e8f0;
      --shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      background: var(--card-bg);
      padding: 30px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      margin-bottom: 30px;
    }

    h1 {
      font-size: 32px;
      margin-bottom: 10px;
      color: var(--primary);
    }

    .endpoint {
      display: inline-block;
      background: var(--bg);
      padding: 8px 16px;
      border-radius: 6px;
      font-family: monospace;
      font-size: 14px;
      margin-top: 10px;
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
      font-size: 18px;
      color: var(--text-muted);
    }

    .loading::after {
      content: '...';
      animation: dots 1.5s steps(4, end) infinite;
    }

    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }

    .error {
      background: #fee;
      color: var(--danger);
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--card-bg);
      padding: 24px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      transition: transform 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .stat-icon {
      font-size: 32px;
      margin-bottom: 10px;
    }

    .stat-value {
      font-size: 36px;
      font-weight: bold;
      color: var(--primary);
      margin: 10px 0;
    }

    .stat-label {
      color: var(--text-muted);
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .tabs {
      background: var(--card-bg);
      padding: 10px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .tab-button {
      padding: 12px 24px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .tab-button:hover {
      background: var(--bg);
      color: var(--text);
    }

    .tab-button.active {
      background: var(--primary);
      color: white;
    }

    .content {
      background: var(--card-bg);
      padding: 30px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      min-height: 400px;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th {
      background: var(--bg);
      padding: 12px;
      text-align: left;
      font-weight: 600;
      font-size: 14px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    td {
      padding: 12px;
      border-bottom: 1px solid var(--border);
    }

    tr:hover {
      background: var(--bg);
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .badge-success {
      background: #d1fae5;
      color: var(--success);
    }

    .badge-warning {
      background: #fef3c7;
      color: var(--warning);
    }

    .badge-info {
      background: #dbeafe;
      color: var(--primary);
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }

    .logo {
      width: 60px;
      height: 40px;
      object-fit: contain;
    }

    .json-container {
      background: #1e293b;
      color: #e2e8f0;
      padding: 20px;
      border-radius: 8px;
      overflow-x: auto;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.5;
      max-height: 600px;
      overflow-y: auto;
    }

    .json-key {
      color: #93c5fd;
    }

    .json-string {
      color: #86efac;
    }

    .json-number {
      color: #fbbf24;
    }

    .json-boolean {
      color: #f87171;
    }

    .search-bar {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
    }

    .search-input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .link {
      color: var(--primary);
      text-decoration: none;
    }

    .link:hover {
      text-decoration: underline;
    }

    .empty {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
    }

    .timestamp {
      text-align: right;
      color: var(--text-muted);
      font-size: 12px;
      margin-top: 20px;
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }

      .tabs {
        flex-direction: column;
      }

      table {
        font-size: 12px;
      }

      th, td {
        padding: 8px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üöÄ API Data Export - Sistema B</h1>
      <p>P√°gina de teste autom√°tica sincronizada com o endpoint de exporta√ß√£o de dados</p>
      <code class="endpoint">/functions/v1/data-export</code>
    </header>

    <div id="loading" class="loading">Carregando dados do endpoint</div>
    <div id="error" class="error" style="display: none;"></div>

    <div id="stats-container" style="display: none;"></div>

    <nav id="tabs" class="tabs" style="display: none;"></nav>

    <main id="content" class="content" style="display: none;"></main>
  </div>

  <script>
    const API_URL = 'https://okeogjgqijbfkudfjadz.supabase.co/functions/v1/data-export';
    let cachedData = null;
    let currentTab = 'brands';

    // ============= FETCH DATA =============
    async function fetchData() {
      try {
        const params = new URLSearchParams({
          format: 'full',
          with_stats: 'true',
          denormalize: 'true'
        });

        console.log('üîÑ Buscando dados do endpoint...');
        const response = await fetch(`${API_URL}?${params}`);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        console.log('‚úÖ Dados recebidos:', data);

        // Armazena ETag para cache
        const etag = response.headers.get('etag');
        if (etag) {
          localStorage.setItem('api-etag', etag);
          console.log('üíæ ETag armazenado:', etag);
        }

        return data;
      } catch (error) {
        console.error('‚ùå Erro ao buscar dados:', error);
        throw error;
      }
    }

    // ============= RENDER STATS =============
    function renderStats(stats) {
      const container = document.getElementById('stats-container');
      container.style.display = 'block';
      
      const statsConfig = [
        { icon: 'üì¶', value: stats.total_brands || 0, label: 'Marcas' },
        { icon: 'üñ®Ô∏è', value: stats.total_models || 0, label: 'Modelos' },
        { icon: '‚öôÔ∏è', value: stats.total_parameter_sets || 0, label: 'Par√¢metros' },
        { icon: 'üß™', value: stats.total_resins || 0, label: 'Resinas' },
        { icon: 'üìö', value: stats.total_knowledge_contents || 0, label: 'Artigos' },
        { icon: 'üé•', value: stats.total_knowledge_videos || 0, label: 'V√≠deos' },
        { icon: 'üè∑Ô∏è', value: stats.total_keywords || 0, label: 'Keywords' },
        { icon: 'üë§', value: stats.total_authors || 0, label: 'Autores' }
      ];

      container.innerHTML = `
        <div class="stats-grid">
          ${statsConfig.map(stat => `
            <div class="stat-card">
              <div class="stat-icon">${stat.icon}</div>
              <div class="stat-value">${stat.value}</div>
              <div class="stat-label">${stat.label}</div>
            </div>
          `).join('')}
        </div>
      `;
    }

    // ============= RENDER TABS =============
    function renderTabs() {
      const tabs = [
        { id: 'brands', label: 'üì¶ Marcas' },
        { id: 'models', label: 'üñ®Ô∏è Modelos' },
        { id: 'parameters', label: '‚öôÔ∏è Par√¢metros' },
        { id: 'resins', label: 'üß™ Resinas' },
        { id: 'knowledge', label: 'üìö Base de Conhecimento' },
        { id: 'authors', label: 'üë§ Autores' },
        { id: 'keywords', label: 'üè∑Ô∏è Keywords' },
        { id: 'json', label: '{ } JSON Completo' }
      ];

      const container = document.getElementById('tabs');
      container.style.display = 'flex';
      container.innerHTML = tabs.map(tab => `
        <button class="tab-button ${tab.id === currentTab ? 'active' : ''}" 
                data-tab="${tab.id}" 
                onclick="switchTab('${tab.id}')">
          ${tab.label}
        </button>
      `).join('');
    }

    // ============= SWITCH TAB =============
    function switchTab(tabId) {
      currentTab = tabId;
      renderTabs();
      renderTabContent(tabId, cachedData);
    }

    // ============= RENDER TAB CONTENT =============
    function renderTabContent(tabId, data) {
      const container = document.getElementById('content');
      container.style.display = 'block';

      switch(tabId) {
        case 'brands':
          renderBrands(data.data.brands);
          break;
        case 'models':
          renderModels(data.data.models);
          break;
        case 'parameters':
          renderParameters(data.data.parameter_sets);
          break;
        case 'resins':
          renderResins(data.data.resins);
          break;
        case 'knowledge':
          renderKnowledge(data.data.knowledge_contents);
          break;
        case 'authors':
          renderAuthors(data.data.authors);
          break;
        case 'keywords':
          renderKeywords(data.data.keywords);
          break;
        case 'json':
          renderJSON(data);
          break;
      }
    }

    // ============= RENDER BRANDS =============
    function renderBrands(brands) {
      const content = document.getElementById('content');
      
      if (!brands || brands.length === 0) {
        content.innerHTML = '<div class="empty">Nenhuma marca encontrada</div>';
        return;
      }

      content.innerHTML = `
        <h2>üì¶ Marcas (${brands.length})</h2>
        <table>
          <thead>
            <tr>
              <th>Logo</th>
              <th>Nome</th>
              <th>Slug</th>
              <th>Modelos</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            ${brands.map(brand => `
              <tr>
                <td>${brand.image_url ? `<img src="${brand.image_url}" class="logo" alt="${brand.name}">` : 'üñºÔ∏è'}</td>
                <td><strong>${brand.name}</strong></td>
                <td><code>${brand.slug}</code></td>
                <td>${brand.models?.length || 0} modelos</td>
                <td><span class="badge badge-success">‚úì Ativo</span></td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    // ============= RENDER MODELS =============
    function renderModels(models) {
      const content = document.getElementById('content');
      
      if (!models || models.length === 0) {
        content.innerHTML = '<div class="empty">Nenhum modelo encontrado</div>';
        return;
      }

      content.innerHTML = `
        <h2>üñ®Ô∏è Modelos de Impressoras (${models.length})</h2>
        <div class="search-bar">
          <input type="search" class="search-input" placeholder="Buscar modelo..." 
                 oninput="filterTable(this.value, 'models-table')">
        </div>
        <table id="models-table">
          <thead>
            <tr>
              <th>Imagem</th>
              <th>Marca</th>
              <th>Nome</th>
              <th>Slug</th>
              <th>Par√¢metros</th>
            </tr>
          </thead>
          <tbody>
            ${models.map(model => `
              <tr>
                <td>${model.image_url ? `<img src="${model.image_url}" class="logo" alt="${model.name}">` : 'üñ®Ô∏è'}</td>
                <td><span class="badge badge-info">${model.brand_name || 'N/A'}</span></td>
                <td><strong>${model.name}</strong></td>
                <td><code>${model.slug}</code></td>
                <td>${model.parameter_sets?.length || 0} conjuntos</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    // ============= RENDER PARAMETERS =============
    function renderParameters(params) {
      const content = document.getElementById('content');
      
      if (!params || params.length === 0) {
        content.innerHTML = '<div class="empty">Nenhum par√¢metro encontrado</div>';
        return;
      }

      content.innerHTML = `
        <h2>‚öôÔ∏è Conjuntos de Par√¢metros (${params.length})</h2>
        <div class="search-bar">
          <input type="search" class="search-input" placeholder="Buscar par√¢metro..." 
                 oninput="filterTable(this.value, 'params-table')">
        </div>
        <table id="params-table">
          <thead>
            <tr>
              <th>Modelo</th>
              <th>Resina</th>
              <th>Tempo</th>
              <th>Temperatura</th>
              <th>Altura da Camada</th>
              <th>Variante</th>
            </tr>
          </thead>
          <tbody>
            ${params.map(param => `
              <tr>
                <td><strong>${param.model_name || 'N/A'}</strong></td>
                <td>${param.resin_name || 'N/A'}</td>
                <td>${param.exposure_time || 'N/A'}s</td>
                <td>${param.temperature || 'N/A'}¬∞C</td>
                <td>${param.layer_height || 'N/A'}mm</td>
                <td>${param.variant_label || 'Padr√£o'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    // ============= RENDER RESINS =============
    function renderResins(resins) {
      const content = document.getElementById('content');
      
      if (!resins || resins.length === 0) {
        content.innerHTML = '<div class="empty">Nenhuma resina encontrada</div>';
        return;
      }

      content.innerHTML = `
        <h2>üß™ Resinas (${resins.length})</h2>
        <div class="search-bar">
          <input type="search" class="search-input" placeholder="Buscar resina..." 
                 oninput="filterTable(this.value, 'resins-table')">
        </div>
        <table id="resins-table">
          <thead>
            <tr>
              <th>Imagem</th>
              <th>Nome</th>
              <th>Fabricante</th>
              <th>Slug</th>
              <th>Keywords</th>
              <th>Pre√ßo</th>
            </tr>
          </thead>
          <tbody>
            ${resins.map(resin => `
              <tr>
                <td>${resin.image_url ? `<img src="${resin.image_url}" class="logo" alt="${resin.name}">` : 'üß™'}</td>
                <td><strong>${resin.name}</strong></td>
                <td>${resin.manufacturer || 'N/A'}</td>
                <td><code>${resin.slug || 'N/A'}</code></td>
                <td>${resin.keywords?.length || 0} keywords</td>
                <td>${resin.price ? `R$ ${resin.price.toFixed(2)}` : 'N/A'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    // ============= RENDER KNOWLEDGE =============
    function renderKnowledge(contents) {
      const content = document.getElementById('content');
      
      if (!contents || contents.length === 0) {
        content.innerHTML = '<div class="empty">Nenhum conte√∫do encontrado</div>';
        return;
      }

      content.innerHTML = `
        <h2>üìö Base de Conhecimento (${contents.length})</h2>
        <div class="search-bar">
          <input type="search" class="search-input" placeholder="Buscar artigo..." 
                 oninput="filterTable(this.value, 'knowledge-table')">
        </div>
        <table id="knowledge-table">
          <thead>
            <tr>
              <th>T√≠tulo</th>
              <th>Autor</th>
              <th>Categoria</th>
              <th>V√≠deos</th>
              <th>Status</th>
              <th>Publicado</th>
            </tr>
          </thead>
          <tbody>
            ${contents.map(item => `
              <tr>
                <td><strong>${item.title}</strong></td>
                <td>${item.author_name || 'N/A'}</td>
                <td><span class="badge badge-info">${item.category_name || 'N/A'}</span></td>
                <td>${item.videos?.length || 0} v√≠deos</td>
                <td><span class="badge ${item.is_published ? 'badge-success' : 'badge-warning'}">
                  ${item.is_published ? '‚úì Publicado' : '‚è≥ Rascunho'}
                </span></td>
                <td>${item.published_at ? new Date(item.published_at).toLocaleDateString('pt-BR') : 'N/A'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    // ============= RENDER AUTHORS =============
    function renderAuthors(authors) {
      const content = document.getElementById('content');
      
      if (!authors || authors.length === 0) {
        content.innerHTML = '<div class="empty">Nenhum autor encontrado</div>';
        return;
      }

      content.innerHTML = `
        <h2>üë§ Autores (${authors.length})</h2>
        <table>
          <thead>
            <tr>
              <th>Foto</th>
              <th>Nome</th>
              <th>Biografia</th>
              <th>Instagram</th>
              <th>LinkedIn</th>
              <th>Artigos</th>
            </tr>
          </thead>
          <tbody>
            ${authors.map(author => `
              <tr>
                <td>${author.photo_url ? `<img src="${author.photo_url}" class="avatar" alt="${author.name}">` : 'üë§'}</td>
                <td><strong>${author.name}</strong></td>
                <td>${author.bio ? author.bio.substring(0, 80) + '...' : 'N/A'}</td>
                <td>${author.instagram_url ? `<a href="${author.instagram_url}" class="link" target="_blank">@${author.instagram_handle || 'Ver'}</a>` : 'N/A'}</td>
                <td>${author.linkedin_url ? `<a href="${author.linkedin_url}" class="link" target="_blank">Ver perfil</a>` : 'N/A'}</td>
                <td>${author.contents?.length || 0} artigos</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    // ============= RENDER KEYWORDS =============
    function renderKeywords(keywords) {
      const content = document.getElementById('content');
      
      if (!keywords || keywords.length === 0) {
        content.innerHTML = '<div class="empty">Nenhuma keyword encontrada</div>';
        return;
      }

      content.innerHTML = `
        <h2>üè∑Ô∏è Keywords / External Links (${keywords.length})</h2>
        <div class="search-bar">
          <input type="search" class="search-input" placeholder="Buscar keyword..." 
                 oninput="filterTable(this.value, 'keywords-table')">
        </div>
        <table id="keywords-table">
          <thead>
            <tr>
              <th>Keyword</th>
              <th>URL</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            ${keywords.map(kw => `
              <tr>
                <td><strong>${kw.keyword}</strong></td>
                <td>${kw.url ? `<a href="${kw.url}" class="link" target="_blank">${kw.url}</a>` : 'N/A'}</td>
                <td><span class="badge badge-success">‚úì Ativo</span></td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    // ============= RENDER JSON =============
    function renderJSON(data) {
      const content = document.getElementById('content');
      const jsonString = JSON.stringify(data, null, 2);
      
      // Syntax highlighting
      const highlighted = jsonString
        .replace(/(".*?"):/g, '<span class="json-key">$1</span>:')
        .replace(/: (".*?")/g, ': <span class="json-string">$1</span>')
        .replace(/: (\d+)/g, ': <span class="json-number">$1</span>')
        .replace(/: (true|false)/g, ': <span class="json-boolean">$1</span>');

      content.innerHTML = `
        <h2>{ } JSON Completo</h2>
        <p style="margin: 10px 0; color: var(--text-muted);">
          Resposta completa do endpoint <code>/data-export?format=full&with_stats=true</code>
        </p>
        <div class="json-container">${highlighted}</div>
        <div class="timestamp">
          √öltima atualiza√ß√£o: ${new Date(data.timestamp).toLocaleString('pt-BR')}
        </div>
      `;
    }

    // ============= FILTER TABLE =============
    function filterTable(searchTerm, tableId) {
      const table = document.getElementById(tableId);
      if (!table) return;

      const rows = table.getElementsByTagName('tr');
      const term = searchTerm.toLowerCase();

      for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(term) ? '' : 'none';
      }
    }

    // ============= INIT =============
    async function init() {
      try {
        cachedData = await fetchData();
        
        document.getElementById('loading').style.display = 'none';
        
        renderStats(cachedData.stats);
        renderTabs();
        renderTabContent(currentTab, cachedData);

        console.log('‚úÖ P√°gina carregada com sucesso!');
      } catch (error) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
        document.getElementById('error').innerHTML = `
          <strong>‚ùå Erro ao carregar dados:</strong><br>
          ${error.message}<br><br>
          Verifique se o endpoint est√° acess√≠vel: <a href="${API_URL}" target="_blank">${API_URL}</a>
        `;
      }
    }

    // Start
    init();

    // Auto-refresh a cada 5 minutos
    setInterval(() => {
      console.log('üîÑ Auto-refresh: verificando atualiza√ß√µes...');
      fetchData().then(data => {
        if (JSON.stringify(data) !== JSON.stringify(cachedData)) {
          console.log('‚úÖ Dados atualizados! Recarregando p√°gina...');
          cachedData = data;
          renderStats(data.stats);
          renderTabContent(currentTab, data);
        }
      }).catch(err => {
        console.warn('‚ö†Ô∏è Erro no auto-refresh:', err.message);
      });
    }, 300000); // 5 minutos
  </script>
</body>
</html>